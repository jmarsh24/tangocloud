<%# locals: { tanda: } %>
<% cache(tanda) do %>
  <% if tanda.recordings.present? %>
    <%= form_with url: load_tanda_recording_path(tanda_id: tanda.id, id: tanda.recordings.first.id) do %>
      <% genre_name = tanda.recordings.first.genre&.name&.downcase || "default" %>
      <% background_class =
        case genre_name
        when "tango" then "bg-tango"
        when "milonga" then "bg-milonga"
        when "vals" then "bg-vals"
        else "bg-default"
        end %>
      <div class="<%= class_names(
                'w-full group snap-start flex flex-col rounded-xl text-neutral-200 transition-transform duration-200 p-4 gap-4 relative',
                background_class
              ) %>">
        <div class="w-full flex flex-col gap-4 z-20">
          <div class="w-full flex justify-start gap-4">
            <div class="relative w-24 flex items-center justify-center">
              <% if tanda.recordings.first.orchestra&.image %>
                <%= image_tag tanda.recordings.first.orchestra.image, alt: tanda.recordings.first.orchestra.name, class: "rounded-lg object-cover aspect-square h-full" %>
              <% else %>
                <div class="w-24 h-24 rounded-lg bg-neutral-400 flex items-center justify-center text-neutral-800">
                  No Image
                </div>
              <% end %>
            </div>
            <div class="flex flex-col gap-4">
              <div class="flex items-start flex-col gap-1">
                <div class="text-xl font-bold line-clamp-1" title="<%= tanda.title %>">
                  <%= tanda.recordings.first.orchestra&.display_name || "Unknown Orchestra" %>
                </div>
                <div class="text-sm text-gray-400 line-clamp-1" title="<%= tanda.recordings.first.genre&.name || "Unknown Genre" %>">
                  <%= tanda.recordings.first.genre&.name || "Unknown Genre" %>
                </div>
                <div class="text-sm text-gray-400 line-clamp-1">
                  <% recordings = tanda.recordings.to_a %>
                  <% year_range = recordings.present? ? "#{recordings.map(&:year).min} - #{recordings.map(&:year).max}" : "No Year Info" %>
                  <%= year_range %>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="flex w-full flex-col z-20 relative border-b border-neutral-500">
          <%= render collection: tanda.recordings, partial: "tandas/recording", locals: { tanda: }, as: :recording %>
        </div>
        <div class="flex w-full justify-between items-center mt-2">
          <!-- Play Button -->
          <%= form_with url: load_tanda_recording_path(tanda_id: tanda.id, id: tanda.recordings.first.id), method: :post do %>
            <button type="submit" class="btn btn-neutral btn-md btn-circle flex items-center justify-center opacity-85">
              <%= heroicon "play", size: :sm, variant: :solid, class: "fill-white-500" %>
            </button>
          <% end %>
          <div class="text-sm text-gray-400 line-clamp-1">
            <% total_minutes, remaining_seconds = tanda.duration.divmod(60) %>
            <%= "#{tanda.recordings_count} recordings, #{total_minutes} min #{remaining_seconds} sec" %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
<% end %>